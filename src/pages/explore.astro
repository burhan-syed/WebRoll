---
// Component Imports
import ExplorePage from "../components/ExplorePage";
import { getSignedImageUrl } from "../server/aws/bucket";
import prisma from "../server/utils/prisma";
const ip = Astro.clientAddress;
await prisma.sessions.deleteMany({ where: { ip: ip } });
const session = await prisma.sessions.create({ data: { ip: ip } });
const allSitesCount = await prisma.site.count({
  where: { status: "APPROVED" },
});
const sites = await prisma.site.findMany({
  where: { status: "APPROVED" },
  take: 3,
  skip: Math.floor(Math.random() * allSitesCount),
  select: {
    id: true,
    imgKey: true,
    url: true,
    name: true,
    description: true,
    sourceLink: true,
    status: true,
    allowEmbed: true,
    categories: { select: { category: true, description: true } },
    tags: { select: { tag: true } },
  },
});
let siteImgURL = "";
if (!sites[0].allowEmbed) {
  siteImgURL = await getSignedImageUrl(sites[0].imgKey as string);
}
console.log("random sites:", sites);
// Full Astro Component Syntax:
// https://docs.astro.build/core-concepts/astro-components/
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>Astro + TailwindCSS</title>
  </head>

  <div class="drawer drawer-end">
    <input id="my-drawer-4" type="checkbox" class="drawer-toggle" />
    <div class="drawer-content">
      <main class="min-h-screen min-w-full flex flex-col">
        {
          sites.length > 0 ? (
            <ExplorePage
              initialSiteImgURL={siteImgURL}
              initialSites={sites}
              ip={ip}
              session={session.id}
              client:load
            />
          ) : (
            <span>no sites found</span>
          )
        }
      </main>
    </div>
    <div class="drawer-side">
      <label for="my-drawer-4" class="drawer-overlay"></label>
      <ul class="menu p-4 overflow-y-auto w-80 bg-base-100 text-base-content">
        <!-- Sidebar content here -->
        <li><a href="/submit">Submit a Site</a></li>
        <li><a>Sidebar Item 2</a></li>
      </ul>
    </div>
  </div>
</html>
